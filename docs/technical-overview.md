# Podium Request Portal — Technical Documentation

## Project summary

Podium Request Portal is an open source web-based application with which researchers can place requests for samples or data (including images) from Dutch biobanks and registries, and where these requests can be tracked and traced. The focus of this project is on supporting only essential (generic) steps of these request processes, keeping in mind that additional functionality might need to be added later on.

Project source code is available in the following repositories:
- https://github.com/thehyve/podium-registry — configuration registry and system health monitoring webapp;
- https://github.com/thehyve/podium — core functionality.

Project codebase is maintained by The Hyve.
To report technical issues and provide feedback you can use the Github Issues page: https://github.com/thehyve/podium/issues


## Purpose of the document

This document is intended to be a succinct technical reference that facilitates updating, testing and further development of the Podium project, and is aimed at people who plan to contribute to the project codebase.
High-level architecture overview, component interactions and major dependencies are included, while implementation details that can be trivially derived from the code (e.g. DTOs) and/or autogenerated (e.g. Swagger API definition, database schema), and user-oriented nuances (e.g. visual elements of the web UIs, installation manual) are omitted.


## Principal components

### Overview


![](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/thehyve/podium/docs/docs/diagrams/system-overview.iuml)


### Registry

The registry is a system administration component that plays a role of a service discovery hub and a configuration provider used by the other components of the Podium system.

Registry frontend is an AngularJS webapp that displays the system health status, lists running component instances, shows configuration options & environment variables, and gives access to various metrics that might be useful to monitor the system status.
The webapp fetches all data from the registry backend only, it does not interact with any other components.
Since the webapp is not supposed to be accessible to end users and is not essential to run the Podium system; it is reasonable to assume that non-backward compatible changes are acceptable during the upgrade as long as a technical user can find metrics necessary for operations & maintenance. The registry webapp might even be completely removed since its functionality overlaps with the one provided by the Gateway webapp.

Supported NodeJS version: 8.12.0+.


The registry Backend is a Spring Boot application, based on Netflix Eureka for service discovery and using Spring Cloud Config to fetch git-based configuration data. The API provided by the registry Backend is essential to run the Podium, but the concrete functionality can better be described in the context of the dependent components, as certain endpoints, e.g. `/config/*`, are not implemented explicitly as a part of the project — see Spring documentation for details.

Current Podium Registry version: 1.0.4; supported JDK version: 8.


### User Accounts & Authentication Server

The UAA component is a Spring Boot application that provides methods for user creation, password management, user search, authentication (username/password, OAuth2) etc, and defines a number of user roles:
- Podium administrator — technical top-level admin role for users who are responsible for keeping the system up and running;
- BBMRI administrator — business top-level admin role for users who are responsible for maintaining the list of active organizations within the system;
- Organisation administrator — role for users who are responsible for keeping organization data up-to-date within the Podium system;
- Organisation coordinator — role for users who are responsible for the progress of data requests (coordinators receive notifications about new / updated data requests, and are able to approve / reject / mark requests for review);
- Reviewer — role for users who are supposed to give feedback / advice on data requests;
- Researcher - the most basic role, able to create and submit data requests.

UAA server sends out emails to request email verification and send password reset links, to inform Podium administrators of user creation/registration etc.

Special users that always exist: "admin", "system".

For data storage, PostgreSQL and ElasticSearch are used.

ElasticSearch index provides complex query-base lookup for Organizations, Roles and Users.

PostgreSQL DB serves as a persistent storage for Authority, Audit Events, Organizations, Roles and Users.
Liquibase is used to initialize/update PostgreSQL DB automatically.

Spring profile, data sources, caching options and other configuration parameters are defined in yaml files included in project resources.

Current Podium UAA version: 1.0.2; supported JDK version: 8.


### Gateway Frontend

Gateway Frontend is a user-facing Angular application.
Supported NodeJS version: 8.12.0+.
Internationalization is supported, but only English translations are present.

#### General Pages

View routes:

`/` — a simple Home page.

`/dashboard` — Dashboard page showing the current user and assigned roles.

`/password` — Password Change page for logged-in users; calls `POST podiumuaa/api/account/change_password`.

`/reset/request` — Password Reset page, calls `POST podiumuaa/api/account/reset_password/init` to send a password reset email.

`/reset/finish` — New Password page that finalizes the password reset process with `POST podiumuaa/api/account/reset_password/finish` call.

`/register` — Registration page, calls `POST podiumuaa/api/register` to create a new user.

`/settings` — User profile settings page, allows a user to specify their phone number / work department / job function.

`/verify` — Verification page, calls `GET podiumuaa/api/verify` and/or `GET podiumuaa/api/reverify` to confirm email after registration.


#### Admin Pages

`/admin/docs` — Swagger API docs.

`/admin/audits` — Audits page that shows system event history; calls `GET podiumuaa/management/audits` to fetch and filter the even list;

`/admin/pdm-configuration` — readonly backend Configuration page; calls `GET management/env` and `GET management/configprops` to get the current server environment variables and JVM/Spring options.

`/admin/pdm-elasticsearch` — Elasticsearch Reindex page; designed to fix ES data/mapping issues with a single button click.

`/admin/pdm-gateway` — active Gateway Routes page; calls `GET api/gateway/routes/` to fetch services registered in Eureka.

`/admin/pdm-health` — Health Checks page, shows system info fetched via `GET podiumuaa/management/health`.

`/admin/logs` — Logging Settings page fetches current server logging configuration via `GET management/logs` and allows an admin user to update these settings via `PUT management/logs`.

`/admin/pdm-metrics` — readonly JVM Application Metrics page, uses `GET management/metrics` and `GET management/dump`.

`/admin/user-management` — User Management page that shows a list of existing users and provides a way to edit/delete/create user entries.

`/bbmri/organisation` — Organization Management page that provides a way to specify organization details, available request types and set permissions for organization members.


#### Requests interface

The requests page (`/requests`) is the primary functional screen of the Gateway Frontend.
It is available to researchers, reviewers and organization coordinators.

It consists of a number of sub-views:

`/my-requests` / `my-organisations` / `my-reviews` — role-dependent Request Overview page; displays existing requests and their statuses.

`/new` / `/edit` — New/Edit Request form; creates draft request items via `PUT api/requests` and submits them for review via `GET api/requests/{uuid}/submit`.

`/detail/{request-guid}` — Request Detail view that displays the current review step and lists attached files.


### Gateway Server

Gateway server is a Java/Spring app that serves as the core component of the Podium system.
It contains entirety of the business-logic for handling Requests and Reviews, including sending emails to involved parties.

Concrete steps of the Review and Delivery processes are defined with [Flowable] in [BPMN 2.0] format.

Gateway server uses ElasticSearch index for Delivery and Review Process info, Request Details and Review Feedback.

PostgreSQL DB is used to store Delivery and Review Process info, Summary Entries, Review Feedback, Principal Investigator info, and Request entries, details, files and templates.
Liquibase is used to initialize/update PostgreSQL DB automatically.

Spring profile, data sources, caching options and other configuration parameters are defined in yaml files included in project resources.

Current Gateway Server version: 1.0.2; supported JDK version: 8.


### Podium Common Package

The podium-common package contains a number of shared methods and constants used by UAA and Gateway components.

It includes shared DTOs, request type and status enums, event definitions, exception classes and various helper methods that are necessary as "plumbing" / glue code, but do not contain any business-logic.


#### Communication between services

The resources are defined as [interfaces in podium-common](../podium-common/src/main/java/nl/thehyve/podium/common/resource).
The servers implement the resources, clients are defined using Feign.

- `InternalUserResource` (server in podium-uaa)
- `InternalRoleResource` (server in podium-uaa)
- `OrganisationResource` (server in podium-uaa)
- `InterhalRequestResource` (server in podium-gateway, required for the RequestSecurityService)
- `InternalAuditResource`: audit events (e.g., status change of requests) are communicated to the UAA component that store the events in the database (server in podium-uaa).

[Clients](../podium-gateway/src/main/java/nl/thehyve/podium/client) defined using [Feign]-annotated interfaces extending the resource interfaces.

UUIDs: Entities are stored using an autoincremented bigint as identifier, but this is not exposed externally. Instead, a uuid is used.


#### Security/access control

Podium-common defines an [access policy aspect](../podium-common/src/main/java/nl/thehyve/podium/common/aop/security/AccessPolicyAspect.java) to enforce access policy for controller methods based on custom security annotations.
The policy is enforced on all classes in the package nl.thehyve.podium.web.rest.
For the annotations, see `Public`, `AnyAuthorisedUser`, `SecuredByAuthority`,
`SecuredByOrganisation`, and `SecuredByCurrentUser`.

The annotations can be applied both on class and on method level. If a method is annotated, the class annotations will be ignored for that method. If a methods is not annotated, the class annotations will be used instead.
If a user tries to access a method for which no rule is satisfied, the advice throws an `AccessDeniedException`.
The annotations are interpreted disjunctively: at least one of the rules needs to be satisfied.

Implemented in the `AccessPolicyService`, which depends on the `SecurityService` and `RequestSecurityService`.

##### Security annotations

[Permission annotations](../podium-common/src/main/java/nl/thehyve/podium/common/security/annotations):

- Public
- AnyAuthorisedUser
- SecuredByAuthority
- SecuredByCurrentUser
- SecuredByOrganisation
- SecuredByRequestOrganisationCoordinator
- SecuredByRequestOrganisationReviewer
- SecuredByRequestOwner

Parameters annotations:

- `OrganisationParameter` / `OrganisationUuidParameter`
- `RequestParameter` / `RequestUuidParameter`
- `UserParameter` / `UserUuidParameter`
  
These parameters point to objects that implement one of `IdentifiableOrganisation`, `IdentifiableRequest` or `IdentifiableUser`.


##### Permission matrix

|                                                                                                               | Coordinator | Reviewer | Researcher |
|---------------------------------------------------------------------------------------------------------------|-------------|----------|------------|
| Fetch delivery processes for a request                                                                        | ✔           | *1       | *1         |
| Start delivery processes for a request                                                                        | ✔           | ✘        | ✘          |
| Release the delivery                                                                                          | ✔           | ✘        | ✘          |
| Cancel a already released delivery                                                                            | ✔           | ✘        | ✘          |
| Mark the delivery as received                                                                                 | ✔           | *1       | *1         |
| Accept a RequestFile and add it to the request                                                                | ✔           | *1       | *1         |
| Return the resource for a file for a given request                                                            | ✔           | ✔        | *1         |
| Return the list of files for a given request                                                                  | ✔           | ✔        | *1         |
| Delete a file from a request                                                                                  | ✔           | *1       | *1         |
| Update the file type for a request file                                                                       | ✔           | *1       | *1         |
| Fetch drafts for the current user                                                                             | ✘           | ✘        | ✔          |
| Create a new request draft                                                                                    | ✘           | ✘        | ✔          |
| Fetch the request draft                                                                                       | *1          | *1       | *1         |
| Update a request draft                                                                                        | *1          | *1       | *1         |
| Validate the request draft                                                                                    | ✔           | ✔        | ✔          |
| Submit the request draft                                                                                      | *1          | *1       | *1         |
| Get all the requests for which the current user is the requester                                              | ✘           | ✘        | ✔          |
| Get all the requests for a requester with a given status                                                      | ✘           | ✘        | ✔          |
| Get request counts for a requester                                                                            | ✘           | ✘        | ✔          |
| Get request counts for a reviewer                                                                             | ✘           | ✔        | ✘          |
| Get all the organisation requests in review status for the organisations where the current user is a reviewer | ✘           | ✔        | ✘          |

*1 — only if a user is an owner of the given request.

## Workflows

[Request review workflow]:

![](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/thehyve/podium/docs/docs/diagrams/request-review-workflow.iuml)

[Delivery workflow]:

![](http://www.plantuml.com/plantuml/proxy?cache=no&src=https://raw.githubusercontent.com/thehyve/podium/docs/docs/diagrams/delivery-workflow.iuml)


## Extra notes and upgrade suggestions

Certain implementation nuances might result in system malfunction after the upgrade, the most obvious one being incorrect HTTP Verbs usage.
Since request entities are created via HTTP `GET` requests, this functionality can break even after a simple proxy configuration change as `GET` requests are often cached.
It would be better to replace every HTTP `GET` endpoint mapping intended to cause side-effects with an appropriate `PUT`/`POST` verb before performing any other code/dependency changes.

Another point of improvement that's best done before the upgrade is to remove redundant functionality.
Since the Registry Webapp provides the administrative functionality included in the Gateway Webapp, it would be reasonable to decomission the registry frontend.
The Registry Backend might also be considered redundand, since both UAA and Gateway systems take most of their configuration options from local configuration files, making Spring Cloud Config functionality superfluous. The remaining feature of the Registry Backend — service discovery — can be served by a third-party stand-alone application such as Consul (or any other service discovery system), reducing the maintainance effort required in the future.

A note on ElasticSearch usage: it is possible to query ES index via the exposed API endpoints, but it seems that most, if not all, ES methods are not used within the app. E.g. `RequestService` class of the Gateway Frontend includes a `search` method calling `GET api/_search/requests` — but this method is never invoked.
It might be possible to get rid of the ElasticSearch dependency.


[//]: # (References)

[Flowable]: https://flowable.com/open-source/docs/
[BPMN 2.0]: https://www.omg.org/spec/BPMN/2.0/About-BPMN/
[Request review workflow]: ../podium-gateway/src/main/resources/processes/podium_request_review.001.bpmn20.xml
[Delivery workflow]: ../podium-gateway/src/main/resources/processes/podium_delivery.001.bpmn20.xml
[Feign]: https://github.com/OpenFeign/feign
